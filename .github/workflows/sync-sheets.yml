name: Sync Sheets to Firestore

on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run sheet sync
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          SCHEDULE_CSV_URL: ${{ secrets.SCHEDULE_CSV_URL }}
          SPEAKERS_CSV_URL: ${{ secrets.SPEAKERS_CSV_URL }}
        run: npm run sync:sheets

      - name: Send Success Email via Resend
        if: success()
        run: |
          TO_LIST="${{ secrets.NOTIFICATION_EMAILS }}"
          IFS=',' read -r -a RECIPS <<< "$TO_LIST"
          json_to="["
          for email in "${RECIPS[@]}"; do
            email_trimmed="$(echo "$email" | xargs)"
            [ -z "$email_trimmed" ] && continue
            json_to="$json_to\"$email_trimmed\"," 
          done
          json_to="${json_to%,}]"
          cat > payload.json <<EOF
          {
            "from": "updates@notifications.thelostproject.in",
            "to": $json_to,
            "subject": "✅ Event Schedule Synced Successfully",
            "html": "<h2>✅ Schedule Sync Success</h2><p>Database updated successfully at 8:00 AM IST</p><p>The latest schedule and speakers have been synced from Google Sheets to Firestore.</p>"
          }
          EOF
          curl -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
        continue-on-error: true

      - name: Send Failure Email via Resend
        if: failure()
        run: |
          TO_LIST="${{ secrets.NOTIFICATION_EMAILS }}"
          IFS=',' read -r -a RECIPS <<< "$TO_LIST"
          json_to="["
          for email in "${RECIPS[@]}"; do
            email_trimmed="$(echo "$email" | xargs)"
            [ -z "$email_trimmed" ] && continue
            json_to="$json_to\"$email_trimmed\"," 
          done
          json_to="${json_to%,}]"
          cat > payload.json <<EOF
          {
            "from": "updates@notifications.thelostproject.in",
            "to": $json_to,
            "subject": "❌ Event Schedule Sync Failed",
            "html": "<h2>❌ Sync Failed</h2><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Check logs</a></p>"
          }
          EOF
          curl -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
        continue-on-error: true
